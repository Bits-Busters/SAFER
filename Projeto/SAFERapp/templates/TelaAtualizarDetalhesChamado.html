{% extends 'TopTemplate.html' %}

{% block extra_css %}
<style>
    .image-preview img {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        float: left;
        margin-right: 15px;
    }

    .image-form {
        clear: both;
    }
</style>
{% endblock %}

{% block title %}Atualizar Ocorrência{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Atualizar Ocorrência</h3>

    <form method="POST" enctype="multipart/form-data" id="form-update-ocorrencia">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_Nome_Autor">Autor:</label>
                    {% if user == ocorrencia.Autor %}
                        {{ form.Nome_Autor }}
                    {% else %}
                        {{ form.Nome_Autor.value }}
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="id_Celular_Autor">Celular:</label>
                    {% if user == ocorrencia.Autor %}
                        {{ form.Celular_Autor }}
                    {% else %}
                        {{ form.Celular_Autor.value }}
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="id_Telefone_Autor">Telefone:</label>
                    {% if user == ocorrencia.Autor %}
                        {{ form.Telefone_Autor }}
                    {% else %}
                        {{ form.Telefone_Autor.value }}
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="id_Relacao_Autor">Relação com a UFRPE:</label>
                    {% if user == ocorrencia.Autor %}
                        {{ form.Relacao_Autor }}
                    {% else %}
                        {{ form.Relacao_Autor.value }}
                    {% endif %}
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_Nome_Animal">Nome do Animal:</label>
                    {{ form.Nome_Animal }}
                </div>
                <div class="form-group">
                    <label for="id_Referencia">Referência:</label>
                    {{ form.Referencia }}
                </div>
                <div class="form-group">
                    <label for="id_Tipo_Caso">Tipo do Caso:</label>
                    {{ form.Tipo_Caso }}
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_Descricao">Descrição:</label>
                    {{ form.Descricao }}
                </div>

                {% if user.tipo_usuario in resgatistas %}
                    <div class="form-group">
                        <label for="id_Status">Status do Chamado:</label>
                        {{ form.Status }}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Formset de imagens -->
        <div class="form-group">
            <label>Imagens:</label>
            {{ formset.management_form }}
            <div id="imagens-container">
                <div id="image-formset">
                    {% for imagem_form in formset|slice:":10" %}
                        <div class="image-form-wrapper" data-form-id="{{ forloop.counter0 }}">
                            <div class="image-form" data-form-id="{{ forloop.counter0 }}">
                                <input type="hidden" name="Imagens_registradas-{{ forloop.counter0 }}-id" value="{{ imagem_form.instance.id|default_if_none:'' }}">
                                <input type="hidden" name="Imagens_registradas-{{ forloop.counter0 }}-IdOcorrencia" value="{{ imagem_form.instance.IdOcorrencia.id|default_if_none:'' }}">

                                <div class="image-preview" id="image-preview-{{ forloop.counter0 }}">
                                    {% if imagem_form.instance.Image %}
                                        <img src="{{ imagem_form.instance.Image.url }}" class="img-thumbnail mt-2" style="max-width: 300px;">
                                    {% endif %}
                                </div>

                                <input type="file" name="Imagens_registradas-{{ forloop.counter0 }}-Image" id="id_Imagens_registradas-{{ forloop.counter0 }}-Image" accept="image/*" class="form-control">
                                <input type="checkbox" name="Imagens_registradas-{{ forloop.counter0 }}-DELETE" id="id_Imagens_registradas-{{ forloop.counter0 }}-DELETE" class="d-none">
                                <button type="button" class="remove-image-form btn btn-danger mt-2">Remover</button>
                            </div>
                            <div style="clear: both;"></div>
                            <hr class="image-divider">
                        </div>
                    {% endfor %}
                </div>

                <!-- Template para novos formulários -->
                <div id="image-form-template" style="display: none;">
                    <div class="image-form-wrapper" data-form-id="__prefix__">
                        <div class="image-form" data-form-id="__prefix__">
                            <div class="image-preview" id="image-preview-__prefix__"></div>
                            <input type="file" name="Imagens_registradas-__prefix__-Image" id="id_Imagens_registradas-__prefix__-Image" accept="image/*" class="form-control">
                            <input type="hidden" name="Imagens_registradas-__prefix__-IdOcorrencia" value="{{ ocorrencia.id }}">
                            <input type="hidden" name="Imagens_registradas-__prefix__-id" value="">
                            <input type="checkbox" name="Imagens_registradas-__prefix__-DELETE" id="id_Imagens_registradas-__prefix__-DELETE" class="d-none">
                            <button type="button" class="remove-image-form btn btn-danger mt-2">Remover</button>
                        </div>
                        <div style="clear: both;"></div>
                        <hr class="image-divider">
                    </div>
                </div>

                <button type="button" id="add-image-form" class="btn btn-primary mt-3">Adicionar Imagem</button>
                <p class="text-muted">Adicione imagens relacionadas ao caso</p>
            </div>
        </div>

        <button type="submit" class="btn btn-success">Atualizar</button>
        <a href="{% url 'telaDetalhesChamado' ocorrencia.id %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
<script>
    // JavaScript de imagens (mesmo que já estava funcionando)
    document.addEventListener('DOMContentLoaded', function () {
        const addButton = document.getElementById('add-image-form');
        const formsetContainer = document.getElementById('image-formset');
        const managementForm = document.querySelector('[name="Imagens_registradas-TOTAL_FORMS"]');
        let limit = 10;
        let current = parseInt(managementForm.value);

        const existingForms = document.querySelectorAll('.image-form');
        existingForms.forEach(form => {
            const formId = form.getAttribute('data-form-id');
            const removeButton = form.querySelector('.remove-image-form');
            if (removeButton) {
                removeButton.addEventListener('click', function () {
                    removeImageForm(formId);
                });
            }
        });

        formsetContainer.addEventListener('change', function (event) {
            if (event.target && event.target.type === 'file') {
                const formId = event.target.closest('.image-form').getAttribute('data-form-id');
                const imagePreviewContainer = document.getElementById('image-preview-' + formId);
                const file = event.target.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgElement = document.createElement('img');
                        imgElement.src = e.target.result;
                        imgElement.classList.add('img-thumbnail', 'mt-2');
                        imagePreviewContainer.innerHTML = '';
                        imagePreviewContainer.appendChild(imgElement);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        if (addButton) {
            addButton.addEventListener('click', function () {
                const totalForms = parseInt(managementForm.value);
                const newFormId = totalForms;

                const template = document.getElementById('image-form-template').innerHTML;
                const newFormHtml = template.replace(/__prefix__/g, newFormId);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newFormHtml.trim();

                const newFormWrapper = tempDiv.querySelector('.image-form-wrapper');
                const newForm = newFormWrapper.querySelector('.image-form');

                newFormWrapper.setAttribute('data-form-id', newFormId);
                newForm.setAttribute('data-form-id', newFormId);

                const imageInput = newForm.querySelector('input[type="file"]');
                imageInput.name = `Imagens_registradas-${newFormId}-Image`;
                imageInput.value = '';

                const previewContainer = newForm.querySelector('.image-preview');
                previewContainer.id = `image-preview-${newFormId}`;
                previewContainer.innerHTML = '';

                const removeButton = newForm.querySelector('.remove-image-form');
                removeButton.addEventListener('click', function () {
                    removeImageForm(newFormId);
                });

                formsetContainer.appendChild(newFormWrapper);

                current++;
                managementForm.value = current;
                checkAddButton();
            });
        }

        function removeImageForm(formId) {
            const formToRemove = formsetContainer.querySelector(`.image-form-wrapper[data-form-id="${formId}"]`);
            if (!formToRemove) return;

            const deleteCheckbox = formToRemove.querySelector(`input[type="checkbox"][name$="-DELETE"]`);
            const idField = formToRemove.querySelector(`input[name$="-id"]`);

            if (idField && idField.value) {
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    formToRemove.style.display = "none";
                    current--;
                }
            } else {
                formToRemove.remove();
                current--;
                managementForm.value = current;
            }

            checkAddButton();
        }

        function checkAddButton() {
            addButton.disabled = current >= limit;
        }
    });

    // Envio AJAX
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('form-update-ocorrencia');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error("Erro na requisição.");
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert("Ocorrência atualizada com sucesso!");
                    window.location.href = data.redirect_url;
                } else {
                    alert("Erro: " + (data.errors ? data.errors.join('\n') : 'Erro ao atualizar a ocorrência.'));
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar:', error);
                alert('Erro ao enviar o formulário. Tente novamente.');
            });
        });
    });
</script>
{% endblock %}
